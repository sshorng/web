<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課堂白板</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Custom styles */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f0f5; /* 更柔和的背景色 */
            overflow: hidden;
            margin: 0;
            color: #333333; /* 更典雅的文字色 */
            transition: background-color 0.3s ease; /* 增加過渡效果 */
        }

        .whiteboard {
            background-color: #f5f5fa; /* 更柔和的背景色 */
            background-image:
                linear-gradient(rgba(200, 200, 220, 0.25) 1px, transparent 1px),
                linear-gradient(90deg, rgba(200, 200, 220, 0.25) 1px, transparent 1px);
            background-size: 25px 25px;
            cursor: crosshair;
            position: relative;
            width: 100%;
            height: calc(100vh - 68px); /* Minus bottom bar height */
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05); /* 增加內部陰影 */
            border-radius: 8px; /* 增加圓角 */
        }

        /* Tool widget styling */
        .tool-widget {
            position: absolute;
            z-index: 10;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            border: 1px solid #e0e0e5;
            border-radius: 0.75rem; /* 更圓潤的邊框 */
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12); /* 加強陰影效果 */
            transition: box-shadow 0.3s ease; /* 增加過渡效果 */
        }
        .tool-widget:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); /* 懸停時加強陰影 */
        }

        /* jQuery UI Resizable Handles - Subtle Styling */
        .ui-resizable-handle {
            position: absolute; font-size: 0.1px; display: block;
            background: transparent; border: none;
            width: 10px; height: 10px; z-index: 90;
        }
        .ui-resizable-n, .ui-resizable-s, .ui-resizable-e, .ui-resizable-w { display: none; }
        .ui-resizable-se { cursor: se-resize; width: 28px; height: 28px; right: -8px; bottom: -8px; }
        .ui-resizable-sw { cursor: sw-resize; width: 28px; height: 28px; left: -8px; bottom: -8px; }
        .ui-resizable-ne { cursor: ne-resize; width: 28px; height: 28px; right: -8px; top: -8px; }
        .ui-resizable-nw { cursor: nw-resize; width: 28px; height: 28px; left: -8px; top: -8px; }

        /* Tool Header */
        .tool-header {
            cursor: move; flex-shrink: 0; background-color: #f9fafb; color: #4b5563;
            border-bottom: 1px solid #f3f4f6; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem;
            padding: 0.6rem 1rem; display: flex; justify-content: space-between; align-items: center;
        }
        .tool-header .font-medium { font-weight: 500; font-size: 0.9rem; }
        .tool-header .btn-icon { color: #9ca3af; }
        .tool-header .btn-icon:hover { background-color: #f3f4f6; color: #6b7281; }
        .tool-header .close-tool:hover { background-color: #fee2e2; color: #ef4444; }

        /* Tool Content */
        .tool-content {
            padding: 2vw; /* 改為使用 vw 單位，或可嘗試 2% 等百分比單位 */
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            background-color: #ffffff;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            font-size: calc(0.8rem + 0.8vw);  /* 調整基礎字體和縮放比例 */
            /* Ensure scrollbar looks decent if it appears */
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f9fafb;
        }
        .tool-content::-webkit-scrollbar { width: 6px; }
        .tool-content::-webkit-scrollbar-track { background: #f9fafb; border-radius: 3px;}
        .tool-content::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; border: 1px solid #f9fafb; }


        /* Sticky Note specific */
        .sticky-note { border: none; }
        .sticky-note .tool-header { color: #374151; border-bottom: 1px solid rgba(0, 0, 0, 0.05); }
        .sticky-note .tool-content { padding: 0; /* Remove padding here */ }
        /* Container for color dots and textarea */
        .sticky-note-body {
            display: flex;
            flex-direction: column;
            height: 100%;
            /* Background color set by JS */
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        .sticky-note-colors { /* Div containing the color dots */
             flex-shrink: 0;
             padding: 0.75rem 0.75rem 0.25rem 0.75rem; /* Adjust padding */
             /* Background color set by JS */
             border-top-left-radius: 0; /* Match parent */
             border-top-right-radius: 0;
        }
        .sticky-note textarea {
            background-color: transparent; border: none; outline: none; width: 100%;
            flex-grow: 1; /* Let textarea grow */
            resize: none; box-sizing: border-box; 
            padding: 1.5vw 2vw; /* 相對內邊距 */
            font-family: inherit; 
            font-size: calc(0.8rem + 0.7vw);  /* 調整字體縮放 */
            color: #374151;
            border-bottom-left-radius: 0.5rem; /* Keep bottom radius */
            border-bottom-right-radius: 0.5rem;
        }
        .sticky-note .color-dot {
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.5);
            transition: transform 0.1s ease-in-out;
            display: inline-block; /* Ensure dots are inline */
            margin-right: 4px; /* Space between dots */
        }
         .sticky-note .color-dot:hover { transform: scale(1.1); }


        /* Collapsed state */
        .collapsed .tool-content { display: none; }
        .collapsed { min-height: auto !important; height: auto !important; }
        .collapsed .tool-header { border-bottom: none; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }

        /* Bottom Control Bar (Merged) */
        .bottom-control-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background-color: #ffffff;
            border-top: 1px solid #e5e7eb; padding: 0.75rem 1.5rem; display: flex;
            justify-content: space-between; align-items: center; z-index: 100;
            height: 68px; box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
        }
        .bottom-control-bar .title-area { font-size: 1.125rem; font-weight: 500; color: #374151; }
        .bottom-control-bar .drawing-tools-area { display: flex; align-items: center; gap: 0.75rem; }
        .bottom-control-bar .action-buttons-area { display: flex; align-items: center; gap: 0.75rem; }

        /* Drawing Tools in Bottom Bar */
        .drawing-color-palette { display: flex; gap: 0.5rem; align-items: center;}
        .drawing-color {
            width: 1.25rem; height: 1.25rem; border-radius: 9999px; border: 2px solid transparent;
            cursor: pointer; transition: all 0.2s ease-in-out; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .drawing-color.active { border-color: #6b7281; transform: scale(1.2); }
        .drawing-size-control { display: flex; align-items: center; gap: 0.5rem; }
        .drawing-size-control i { color: #9ca3af; }
        .drawing-size-control input[type="range"] { width: 5rem; cursor: pointer; accent-color: #c4b5fd; height: 0.5rem; }
        .bottom-control-bar .btn-secondary, .bottom-control-bar .btn-danger-outline { padding: 0.3rem 0.8rem; font-size: 0.875rem; }
        .bottom-control-bar .btn-secondary i, .bottom-control-bar .btn-danger-outline i { margin-right: 0.25rem; }

        /* General Button Styles */
        .btn-primary { background-color: #6a1b9a; /* 更典雅的紫色 */
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem; /* 更圓潤的邊框 */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            border: none;
            font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* 增加陰影 */
        }
        .btn-primary:hover {
            background-color: #4a148c; /* 深色變體 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-primary:hover { background-color: #9370DB; }
        .btn-outline { background-color: transparent; color: #6a1b9a; /* 更典雅的紫色 */
            border: 1px solid #6a1b9a;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem; /* 更圓潤的邊框 */
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
            font-size: 0.875rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .btn-outline:hover {
            background-color: #f0e0ff; /* 柔和的背景色 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-outline:hover { background-color: #f3e8ff; color: #9370DB; }
        .btn-secondary { background-color: #f3f4f6; color: #4b5563; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s; border: 1px solid #e5e7eb; font-size: 0.875rem; }
        .btn-secondary:hover { background-color: #e5e7eb; }
        .btn-danger-outline { background-color: transparent; color: #f87171; border: 1px solid #fca5a5; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s, border-color 0.2s; font-size: 0.875rem; }
        .btn-danger-outline:hover { background-color: #fee2e2; color: #ef4444; border-color: #ef4444; }

        /* Tool Dropdown */
        #tool-dropdown { position: absolute; border: 1px solid #e5e7eb; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); bottom: 100%; margin-bottom: 0.5rem; z-index: 99999; }
        #tool-dropdown .add-tool-item { color: #4b5563; transition: background-color 0.15s; font-size: 0.875rem; }
        #tool-dropdown .add-tool-item:hover { background-color: #f3e8ff; color: #9370DB; }
        #tool-dropdown .add-tool-item i { color: #a78bfa; margin-right: 0.75rem; width: 1em; text-align: center; }
        #tool-dropdown .add-tool-item:hover i { color: #9370DB; }

        /* Timer */
        .timer-widget {
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: space-between;
        }
        .timer-display {
            font-size: calc(3rem + 2.5vw);  /* 調整字體縮放 */
            font-weight: 700;
            text-align: center;
            margin: 5px 0 15px 0;
            color: #6b7281;
            font-family: 'Courier New', monospace;
            letter-spacing: -2px;
        }
        .timer-display.times-up { 
            color: #ef4444; 
            animation: pulse 1s infinite; 
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        .timer-widget .timer-start,
        .timer-widget .timer-reset {
            font-size: 0.875rem;
            padding: 0.4rem 0.8rem;
        }
        .timer-widget .time-preset {
            background-color: #f3f4f6;
            color: #4b5563;
            border: 1px solid #e5e7eb;
            transition: background-color 0.2s;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .timer-widget .time-preset:hover {
            background-color: #e5e7eb;
        }
        .timer-widget input[type="number"] {
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            text-align: center;
            color: #374151;
            padding: 0.25rem;
            font-size: 0.9rem;
        }

        /* Picker */
        .picker-widget {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .picker-widget .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem 0.375rem 0 0;
            border: 1px solid #e5e7eb;
            border-bottom: none;
            background-color: #f9fafb;
            color: #6b7281;
            transition: background-color 0.2s, color 0.2s;
            margin-bottom: -1px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .picker-widget .tab-button.active { background-color: #ffffff; color: #a78bfa; border-color: #e5e7eb; font-weight: 500; }
        .picker-widget .tab-content { border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0 0.375rem 0.375rem 0.375rem; background-color: #ffffff; }
        .picker-widget .tab-content.active { display: block; }
        .picker-widget .tab-content:not(.active) { display: none; }
        .picker-widget textarea,
        .picker-widget select,
        .picker-widget input[type="text"] {
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            padding: 0.5rem;
            color: #374151;
            font-size: 0.9rem;
        }
        .picker-widget .class-list-container { max-height: 130px; overflow-y: auto; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.25rem; padding: 0.5rem; }
        .picker-widget .class-item { background-color: #ffffff; border: 1px solid #e5e7eb; transition: background-color 0.15s; }
        .picker-widget .class-item:hover { background-color: #f3f4f6; }
        .picker-widget .class-item .btn-icon i { color: #9ca3af; transition: color 0.15s; }
        .picker-widget .class-item .edit-class:hover i { color: #a78bfa; }
        .picker-widget .class-item .delete-class:hover i { color: #ef4444; }
        .picker-result {
            font-size: calc(1.5rem + 1.5vw);  /* 調整字體縮放 */
            font-weight: 800;
            min-height: 70px; /* 可以考慮是否也需要相對單位 */
            color: #6d28d9;
            background-color: #f3f4f6;
            border: 2px dashed #a78bfa;
            padding: 1.5vw; /* 相對內邊距 */
            letter-spacing: 2px;
            border-radius: 0.5rem;
            box-shadow: 0 2px 12px 0 rgba(168,139,250,0.08);
            transition: transform 0.2s cubic-bezier(.68,-0.55,.27,1.55), box-shadow 0.2s;
        }
        .picker-result.animate-pop {
            animation: picker-pop 0.5s cubic-bezier(.68,-0.55,.27,1.55);
        }
        @keyframes picker-pop {
            0% { transform: scale(1); box-shadow: 0 2px 12px 0 rgba(168,139,250,0.08); }
            40% { transform: scale(1.25); box-shadow: 0 6px 24px 0 rgba(168,139,250,0.18); }
            100% { transform: scale(1); box-shadow: 0 2px 12px 0 rgba(168,139,250,0.08); }
        }
        .picker-widget .picker-controls { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
        .picker-widget .picker-pick { flex-grow: 1; }
        .picker-widget .restore-list-btn { padding: 0.5rem 0.8rem; font-size: 0.8rem; flex-shrink: 0; }
        .picker-widget .restore-list-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .picker-widget .remove-option { display: flex; align-items: center; margin-top: 0.75rem; font-size: 0.8rem; color: #6b7281; }
        .picker-widget .remove-option input[type="checkbox"] { margin-right: 0.5rem; accent-color: #a78bfa; cursor: pointer; }
        .picker-widget .remove-option label { cursor: pointer; }

        /* YouTube */
        .youtube-widget {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .youtube-container {
            flex-grow: 1;
            position: relative;
            min-height: 0;
            background-color: #e5e7eb;
            border-radius: 0.375rem;
        }
        .youtube-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        .youtube-placeholder { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; color: #9ca3af; background-color: #f3f4f6; border-radius: 0.375rem; }
        .youtube-widget input[type="text"] {
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            padding: 0.5rem;
            color: #374151;
            font-size: 0.9rem;
        }
        .youtube-widget .youtube-load {
            font-size: 0.875rem;
            padding: 0.4rem 0.8rem;
        }

        /* Clock & Calendar */
        .clock-widget {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            text-align: center;
        }
        .clock-time {
            font-size: calc(1.5rem + 1vw); /* 調整字體縮放 */
            font-weight: 600;
            color: #4b5563;
        }
        .clock-date {
            font-size: 0.8rem;
            color: #6b7281;
        }
        .calendar-widget {
            display: flex;
            flex-direction: column;
            height: 100%;
            text-align: center;
        }
        .calendar-month-year {
            font-weight: 500;
            color: #4b5563;
            font-size: 0.9rem;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0.25rem;
            text-align: center;
        }
        .calendar-grid div { padding: 0.25rem; border-radius: 0.25rem; }
        .calendar-days .calendar-day { color: #4b5563; cursor: default; transition: background-color 0.15s; font-size: 0.8rem; }
        .calendar-days .calendar-day:not(.opacity-50):hover { background-color: #f3f4f6; }
        .calendar-days .today { background-color: #ede9fe; color: #7c3aed; font-weight: 600; }
        .calendar-widget .btn-icon {
            color: #9ca3af;
        }
        .calendar-widget .btn-icon:hover { background-color: #e5e7eb; }

        /* General Input/Select Focus */
        input:focus, select:focus, textarea:focus { outline: none; border-color: #a78bfa !important; box-shadow: 0 0 0 2px #ede9fe !important; }

        .picker-widget .class-name {
            width: 6rem;
        }

        /* Bookmark Widget */
        .bookmark-widget { display: flex; flex-direction: column; height: 100%; }
        .bookmark-list { flex: 1 1 auto; overflow-y: auto; margin-bottom: 0.5rem; }
        .bookmark-item { display: flex; align-items: center; justify-content: space-between; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.4rem 0.7rem; margin-bottom: 0.5vh; transition: background 0.2s; }
        .bookmark-item:hover { background: #ede9fe; }
        .bookmark-link { color: #7c3aed; font-weight: 600; text-decoration: none; word-break: break-all; font-size: 0.9rem; padding: 0.3em 0.5em; }  /* 稍微調大字體 */
        .bookmark-link:hover { text-decoration: underline; }
        .bookmark-actions { display: flex; gap: 0.3rem; }
        .bookmark-actions .btn-icon { color: #9ca3af; padding: 0.2rem; font-size: 0.7rem; }
        .bookmark-actions .btn-icon:hover { color: #ef4444; background: #fee2e2; }
        .bookmark-add-form { display: flex; gap: 0.4rem; margin-top: 0.5rem; }
        .bookmark-add-form input[type="text"] { border: 1px solid #d1d5db; border-radius: 0.25rem; padding: 0.3rem 0.5rem; font-size: 0.95rem; flex: 1 1 0; min-width: 0; }
        .bookmark-add-form .btn-primary { padding: 0.3rem 0.9rem; font-size: 0.9rem; flex-shrink: 0; }

        /* Group Widget (with class management) */
        .group-widget .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem 0.375rem 0 0;
            border: 1px solid #e5e7eb;
            border-bottom: none;
            background-color: #f9fafb;
            color: #6b7281;
            transition: background-color 0.2s, color 0.2s;
            margin-bottom: -1px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .group-widget .tab-button.active { background-color: #ffffff; color: #a78bfa; border-color: #e5e7eb; font-weight: 500; }
        .group-widget .tab-content { border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0 0.375rem 0.375rem 0.375rem; background-color: #ffffff; }
        .group-widget .tab-content.active { display: block; }
        .group-widget .tab-content:not(.active) { display: none; }
        .group-widget .class-list-container { max-height: 130px; overflow-y: auto; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.25rem; padding: 0.5rem; }
        .group-widget .class-item { background-color: #ffffff; border: 1px solid #e5e7eb; transition: background-color 0.15s; }
        .group-widget .class-item:hover { background-color: #f3f4f6; }
        .group-widget .class-item .btn-icon i { color: #9ca3af; transition: color 0.15s; }
        .group-widget .class-item .edit-class:hover i { color: #a78bfa; }
        .group-widget .class-item .delete-class:hover i { color: #ef4444; }
        .group-widget .restore-list-btn { padding: 0.5rem 0.8rem; font-size: 0.8rem; flex-shrink: 0; }
        .group-widget .restore-list-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .group-widget .remove-option { display: flex; align-items: center; margin-top: 0.75rem; font-size: 0.8rem; color: #6b7281; }
        .group-widget .remove-option input[type="checkbox"] { margin-right: 0.5rem; accent-color: #a78bfa; cursor: pointer; }
        .group-widget .remove-option label { cursor: pointer; }

        .group-widget .group-options input.group-count,
        .group-widget .group-options input.group-size {
            width: 2.5em;
        }

    </style>
</head>
<body>
    <div class="flex flex-col h-screen">
        <div id="whiteboard" class="whiteboard flex-1 relative">
            <canvas id="drawing-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
            </div>

        <div class="bottom-control-bar">
            <div class="title-area">課堂白板</div>
            <div class="drawing-tools-area">
                <div class="drawing-color-palette">
                    <div class="drawing-color active" style="background-color: #a78bfa;" data-color="#a78bfa" title="淡紫"></div>
                    <div class="drawing-color" style="background-color: #c4b5fd;" data-color="#c4b5fd" title="丁香紫"></div>
                    <div class="drawing-color" style="background-color: #d8b4fe;" data-color="#d8b4fe" title="粉紫"></div>
                    <div class="drawing-color" style="background-color: #fca5a5;" data-color="#fca5a5" title="淡紅"></div>
                    <div class="drawing-color" style="background-color: #fdba74;" data-color="#fdba74" title="淡橙"></div>
                    <div class="drawing-color" style="background-color: #fde047;" data-color="#fde047" title="黃"></div>
                    <div class="drawing-color" style="background-color: #a3e635;" data-color="#a3e635" title="萊姆綠"></div>
                    <div class="drawing-color" style="background-color: #67e8f9;" data-color="#67e8f9" title="天藍"></div>
                    <div class="drawing-color" style="background-color: #94a3b8;" data-color="#94a3b8" title="中灰"></div>
                    <div class="drawing-color" style="background-color: #4b5563;" data-color="#4b5563" title="深灰"></div>
                    <div class="drawing-color" style="background-color: #1f2937;" data-color="#1f2937" title="近黑"></div>
                </div>
                <div class="drawing-size-control">
                    <i class="fas fa-pencil-alt"></i>
                    <input type="range" min="1" max="15" value="3" class="drawing-size">
                </div>
                <button id="eraser-tool" class="btn-secondary">
                    <i class="fas fa-eraser"></i> 
                </button>
                <button id="undo-drawing" class="btn-secondary" disabled>
                    <i class="fas fa-undo"></i> 
                </button>
                <button id="redo-drawing" class="btn-secondary" disabled>
                    <i class="fas fa-redo"></i> 
                </button>
                <button id="clear-drawing" class="btn-danger-outline">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
            <div class="action-buttons-area">
                <button id="clear-board" class="btn-outline"> <i class="fas fa-eraser mr-1"></i> 清空白板 </button>
                <div class="relative">
                    <button id="add-tool" class="btn-primary"> <i class="fas fa-plus mr-1"></i> 新增工具 </button>
                    <div id="tool-dropdown" class="hidden absolute right-0 w-48 bg-white rounded-md shadow-lg z-50 border border-gray-200" style="bottom: 100%; margin-bottom: 0.5rem;">
                        <div class="py-1">
                            <a href="#" class="add-tool-item block px-4 py-2" data-tool="timer"><i class="fas fa-hourglass-half"></i>倒數計時器</a>
                            <a href="#" class="add-tool-item block px-4 py-2" data-tool="picker"><i class="fas fa-random"></i>隨機抽籤</a>
                            <a href="#" class="add-tool-item block px-4 py-2" data-tool="sticky"><i class="fas fa-sticky-note"></i>便利貼</a>
                            <a href="#" class="add-tool-item block px-4 py-2" data-tool="youtube"><i class="fab fa-youtube"></i>YouTube</a>
                            <a href="#" class="add-tool-item block px-4 py-2" data-tool="clock"><i class="fas fa-clock"></i>時鐘</a>
                            <a href="#" class="add-tool-item block px-4 py-2" data-tool="calendar"><i class="fas fa-calendar-alt"></i>日曆</a>
                            <a href="#" class="add-tool-item block px-4 py-2" data-tool="bookmark"><i class="fas fa-bookmark"></i>書籤</a>
                            <a href="#" class="add-tool-item block px-4 py-2" data-tool="group"><i class="fas fa-users"></i>分組工具</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <audio id="timer-audio" src="countdown.mp3"></audio>

    <script>
        $(function() {
            // --- Global Setup & Polyfills ---
            if (typeof $.ui.dialog.prototype._allowInteraction === 'function') {
                $.ui.dialog.prototype._allowInteraction = function(event) {
                    return !!$(event.target).closest(".cke_dialog, .cke").length || this._super(event);
                };
            }

            // --- Responsive Font Size Adjuster ---
            function adjustFontSize() {
                const toolContents = document.querySelectorAll('.tool-content, .sticky-note textarea, .timer-display, .picker-result');
                toolContents.forEach(element => {
                    // This is a simple example. You can develop a more sophisticated formula.
                    // The base size is in 'rem', and it scales with a portion of the viewport width.
                    // The values (e.g., 0.8rem, 0.8vw) can be tweaked for best results.
                    let baseSize = 0.8; // in rem
                    let scaleFactor = 0.8; // portion of viewport width
                    if(element.classList.contains('timer-display')) {
                        baseSize = 3; scaleFactor = 2.5;
                    } else if (element.classList.contains('picker-result')) {
                        baseSize = 1.5; scaleFactor = 1.5;
                    }
                    element.style.fontSize = `calc(${baseSize}rem + ${scaleFactor}vw)`;
                });
            }


            // --- Core Application Logic ---
            const whiteboard = $('#whiteboard');
            const timerAudio = document.getElementById('timer-audio');
            const canvas = document.getElementById('drawing-canvas');
            const ctx = canvas.getContext('2d');
            const eraserBtn = document.getElementById('eraser-tool');
            const clearDrawingBtn = document.getElementById('clear-drawing');
            const colorBtns = document.querySelectorAll('.drawing-color');
            const sizeInput = document.querySelector('.drawing-size');

            let toolCounter = 0;
            let drawingState = {
                isDrawing: false, lastX: 0, lastY: 0,
                color: '#a78bfa', lineWidth: 3,
                isEraser: false, saveTimeout: null
            };

            const STORAGE_KEY_TOOLS = 'classroom_whiteboard_tools_v7'; // Version bump for size memory fix
            const STORAGE_KEY_DRAWING = 'classroom_whiteboard_drawing_v5';
            const STORAGE_KEY_PICKER_CLASSES = 'classroom_whiteboard_picker_classes_v5';

            // --- Canvas & Drawing Functions ---
            function resizeCanvas() {
                const currentDrawingDataUrl = canvas.toDataURL();
                canvas.width = whiteboard.width();
                canvas.height = whiteboard.height();
                if (currentDrawingDataUrl) {
                    const img = new Image();
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0);
                        applyDrawingSettings();
                    };
                    img.onerror = () => console.error("Failed to load saved drawing on resize.");
                    img.src = currentDrawingDataUrl;
                } else {
                    applyDrawingSettings();
                }
            }
            function applyDrawingSettings() { ctx.strokeStyle = drawingState.color; ctx.lineWidth = drawingState.lineWidth; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.globalCompositeOperation = drawingState.isEraser ? 'destination-out' : 'source-over'; }
            function saveDrawing() { if (drawingState.saveTimeout) clearTimeout(drawingState.saveTimeout); drawingState.saveTimeout = setTimeout(() => { try { if (canvas.width > 0 && canvas.height > 0) localStorage.setItem(STORAGE_KEY_DRAWING, canvas.toDataURL()); } catch (e) { console.error('Error saving drawing:', e); if (e.name === 'QuotaExceededError') alert('無法儲存繪圖，本機儲存空間已滿。'); } }, 500); }
            function getEventCoords(e) { const rect = canvas.getBoundingClientRect(); const touch = e.touches && e.touches[0]; return { x: (touch ? touch.clientX : e.clientX) - rect.left, y: (touch ? touch.clientY : e.clientY) - rect.top }; }
            function startDrawing(e) { if (e.button !== 0 && e.type === 'mousedown') return; drawingState.isDrawing = true; const coords = getEventCoords(e); [drawingState.lastX, drawingState.lastY] = [coords.x, coords.y]; ctx.beginPath(); applyDrawingSettings(); if (drawingState.isEraser) { ctx.arc(drawingState.lastX, drawingState.lastY, drawingState.lineWidth * 2.5, 0, Math.PI * 2); ctx.fill(); } else { ctx.fillStyle = drawingState.color; ctx.arc(drawingState.lastX, drawingState.lastY, drawingState.lineWidth / 2, 0, Math.PI * 2); ctx.fill(); } }
            function startDrawingTouch(e) { e.preventDefault(); startDrawing(e); }
            function draw(e) { if (!drawingState.isDrawing) return; const coords = getEventCoords(e); ctx.beginPath(); ctx.moveTo(drawingState.lastX, drawingState.lastY); ctx.lineTo(coords.x, coords.y); ctx.globalCompositeOperation = drawingState.isEraser ? 'destination-out' : 'source-over'; ctx.lineWidth = drawingState.isEraser ? drawingState.lineWidth * 5 : drawingState.lineWidth; ctx.strokeStyle = drawingState.isEraser ? 'rgba(0,0,0,1)' : drawingState.color; ctx.stroke(); [drawingState.lastX, drawingState.lastY] = [coords.x, coords.y]; }
            function drawTouch(e) { e.preventDefault(); draw(e); }
            function stopDrawing() { if (drawingState.isDrawing) { drawingState.isDrawing = false; saveDrawing(); applyDrawingSettings(); } }

            // --- Event Listeners ---
            $(canvas).on('mousedown', startDrawing).on('mousemove', draw).on('mouseup mouseout', stopDrawing);
            canvas.addEventListener('touchstart', startDrawingTouch, { passive: false });
            canvas.addEventListener('touchmove', drawTouch, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);

            $(window).on('resize', resizeCanvas);
            $('#eraser-tool').on('click', function() { drawingState.isEraser = !drawingState.isEraser; $(this).toggleClass('bg-gray-200 bg-gray-500 text-white'); canvas.style.cursor = drawingState.isEraser ? 'cell' : 'crosshair'; applyDrawingSettings(); });
            $('#clear-drawing').on('click', () => { if (confirm('確定要清除所有繪圖內容嗎？')) clearDrawingCanvas(); });
            $('.drawing-color').on('click', function() { $('.drawing-color').removeClass('active'); $(this).addClass('active'); drawingState.color = $(this).data('color'); if (drawingState.isEraser) { $('#eraser-tool').click(); } else { applyDrawingSettings(); } });
            $('.drawing-size').on('input', function() { drawingState.lineWidth = parseInt($(this).val()); if (!drawingState.isEraser) { applyDrawingSettings(); } });
            $('#add-tool').on('click', () => $('#tool-dropdown').toggleClass('hidden'));
            $(document).on('click', (e) => { if (!$(e.target).closest('#add-tool, #tool-dropdown').length) $('#tool-dropdown').addClass('hidden'); });
            $('#clear-board').on('click', () => { if (confirm('確定要清除白板上的所有工具和繪圖嗎？')) clearWhiteboard(); });
            $('.add-tool-item').on('click', function(e) { e.preventDefault(); createTool($(this).data('tool')); $('#tool-dropdown').addClass('hidden'); });

            // --- Utility Functions ---
            function clearDrawingCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); localStorage.removeItem(STORAGE_KEY_DRAWING); applyDrawingSettings(); drawingState.isDrawing = false; }
            function clearWhiteboard() { $('.tool-widget').each((_, tool) => clearToolResources(tool)).remove(); clearDrawingCanvas(); localStorage.removeItem(STORAGE_KEY_TOOLS); localStorage.removeItem(STORAGE_KEY_PICKER_CLASSES); toolCounter = 0; }
            function bringToFront(element) { let maxZ = 9; $('.tool-widget').each((_, el) => maxZ = Math.max(maxZ, parseInt($(el).css('zIndex')) || 10)); $(element).css('zIndex', maxZ + 1); saveToolsState(); }
            function clearToolResources(tool) { const $tool = $(tool); const toolType = $tool.data('type'); if (toolType === 'timer') { clearInterval($tool.data('countdownInterval')); const audio = timerAudio; if (audio && !audio.paused) { audio.pause(); audio.currentTime = 0; } } else if (toolType === 'clock') { clearInterval($tool.data('clockIntervalId')); } else if (toolType === 'picker') { $tool.removeData('originalNames'); } }
            function lightenColor(hex, percent) { hex = hex.replace(/^\s*#|\s*$/g, ''); if(hex.length == 3) hex = hex.replace(/(.)/g, '$1$1'); let r = parseInt(hex.substr(0, 2), 16), g = parseInt(hex.substr(2, 2), 16), b = parseInt(hex.substr(4, 2), 16); const p = percent / 100; r = Math.round(Math.min(255, Math.max(0, r * (1 + p)))); g = Math.round(Math.min(255, Math.max(0, g * (1 + p)))); b = Math.round(Math.min(255, Math.max(0, b * (1 + p)))); return `#${(r).toString(16).padStart(2, '0')}${(g).toString(16).padStart(2, '0')}${(b).toString(16).padStart(2, '0')}`; }

            // --- Tool Creation & Management ---
            function createTool(toolType, savedState = {}) {
                toolCounter++;
                const toolId = `tool-${toolCounter}`;
                let toolContentHTML = '', toolTitle = '', toolClasses = '';

                // Define tool dimensions
                const toolWidth = toolType === 'timer' ? 320 :
                                toolType === 'picker' ? 300 :
                                toolType === 'sticky' ? 230 :
                                toolType === 'youtube' ? 400 : 280;
                const toolHeight = toolType === 'picker' ? 420 : 180;


                // Build tool-specific HTML
                switch (toolType) {
                    case 'sticky':
                        toolClasses = 'sticky-note';
                        toolTitle = '便利貼';
                        toolContentHTML = `<div class="sticky-note-body">
                            <div class="sticky-note-colors">
                                <span class="color-dot w-5 h-5 rounded-full inline-block cursor-pointer" style="background-color: #fef9c3;" data-color="#fef9c3"></span>
                                <span class="color-dot w-5 h-5 rounded-full inline-block cursor-pointer" style="background-color: #dbeafe;" data-color="#dbeafe"></span>
                                <span class="color-dot w-5 h-5 rounded-full inline-block cursor-pointer" style="background-color: #dcfce7;" data-color="#dcfce7"></span>
                                <span class="color-dot w-5 h-5 rounded-full inline-block cursor-pointer" style="background-color: #fce7f3;" data-color="#fce7f3"></span>
                                <span class="color-dot w-5 h-5 rounded-full inline-block cursor-pointer" style="background-color: #fae8ff;" data-color="#fae8ff"></span>
                            </div>
                            <textarea class="sticky-content p-3 w-full h-full bg-transparent border-0 resize-none focus:outline-none" placeholder="輸入文字..."></textarea>
                        </div>`;
                        break;
                     case 'timer':
                        toolTitle = '倒數計時器';
                        toolContentHTML = `<div class="flex flex-col items-center justify-center p-4 timer-widget">
                            <div class="timer-display">
                                <span class="timer-minutes">05</span>:<span class="timer-seconds">00</span>
                            </div>
                            <div class="flex items-center space-x-2 mb-3">
                                <label for="${toolId}-minutes" class="text-sm">分:</label>
                                <input type="number" id="${toolId}-minutes" min="0" max="99" value="5" class="w-16 text-center timer-minutes-input">
                                <label for="${toolId}-seconds" class="text-sm">秒:</label>
                                <input type="number" id="${toolId}-seconds" min="0" max="59" value="0" class="w-16 text-center timer-seconds-input">
                            </div>
                            <div class="flex space-x-2 mb-3">
                                <button class="btn-secondary time-preset" data-min="1" data-sec="0">1分</button>
                                <button class="btn-secondary time-preset" data-min="3" data-sec="0">3分</button>
                                <button class="btn-secondary time-preset" data-min="5" data-sec="0">5分</button>
                                <button class="btn-secondary time-preset" data-min="10" data-sec="0">10分</button>
                            </div>
                            <div class="flex space-x-2 w-full">
                                <button class="btn-primary timer-start flex-1">開始</button>
                                <button class="btn-outline timer-reset flex-1">重設</button>
                            </div>
                        </div>`;
                        break;
                    case 'picker':
                         toolTitle = '隨機抽籤';
                         toolContentHTML = `<div class="flex flex-col space-y-2 picker-widget">
                             <div class="flex border-b border-gray-200 -mt-4 -mx-4 px-4">
                                 <button class="tab-button active" data-tab="names">抽籤</button>
                                 <button class="tab-button" data-tab="manage">班級管理</button>
                             </div>
                             <div class="tab-content active" data-tab="names">
                                     <div class="flex space-x-2 items-center mb-2">
                                         <label for="${toolId}-class-select" class="text-xs text-gray-600 flex-shrink-0">班級:</label>
                                         <select id="${toolId}-class-select" class="class-select flex-1 text-sm">
                                             <option value="">-- 無班級 --</option>
                                         </select>
                                     </div>
                                     <textarea class="picker-names p-2 h-20 text-sm" placeholder="輸入名稱，每行一個">${savedState.names || ''}</textarea>
                                     <div class="remove-option">
                                         <input type="checkbox" id="${toolId}-remove-picked" class="remove-picked-checkbox" ${savedState.removePicked ? 'checked' : ''}>
                                         <label for="${toolId}-remove-picked">抽出後自動移除</label>
                                     </div>
                             </div>
                             <div class="tab-content" data-tab="manage">
                                 <div class="flex items-center space-x-2 mb-2">
                                     <input type="text" class="class-name flex-1 text-sm" placeholder="新班級名稱...">
                                     <button class="btn-primary add-class text-sm">新增</button>
                                 </div>
                                 <div class="class-list-container">
                                     <p class="text-center text-gray-500 text-xs p-2">尚未新增任何班級</p>
                                 </div>
                             </div>
                             <div class="text-center border rounded picker-result flex items-center justify-center">--</div>
                             <div class="picker-controls">
                                 <button class="btn-primary picker-pick py-2 rounded-md">抽籤</button>
                                 <button class="btn-secondary restore-list-btn" title="恢復目前班級的原始名單" disabled>
                                     <i class="fas fa-undo"></i>
                                 </button>
                             </div>
                         </div>`;
                        break;
                    case 'youtube':
                        toolTitle = 'YouTube';
                        toolContentHTML = `<div class="youtube-widget p-2 space-y-2">
                            <div class="flex space-x-2">
                                <input type="text" class="youtube-url-input flex-1 text-sm" placeholder="貼上 YouTube 網址或影片 ID">
                                <button class="btn-primary youtube-load">載入</button>
                            </div>
                            <div class="youtube-container rounded-md overflow-hidden">
                                <div class="youtube-placeholder">
                                    <i class="fab fa-youtube text-4xl"></i>
                                </div>
                            </div>
                        </div>`;
                        break;
                    case 'clock':
                        toolTitle = '時鐘';
                        toolContentHTML = `<div class="clock-widget p-4">
                            <div class="clock-time">12:00:00</div>
                            <div class="clock-date">2023年10月27日 星期五</div>
                        </div>`;
                        break;
                    case 'calendar':
                        toolTitle = '日曆';
                        toolContentHTML = `<div class="calendar-widget p-2 text-sm">
                            <div class="flex items-center justify-between mb-2 px-2">
                                <button class="btn-icon prev-month w-7 h-7 flex items-center justify-center rounded-full"><i class="fas fa-chevron-left"></i></button>
                                <div class="calendar-month-year font-medium"></div>
                                <button class="btn-icon next-month w-7 h-7 flex items-center justify-center rounded-full"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="calendar-grid weekdays text-xs text-gray-500 mb-1">
                                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                            </div>
                            <div class="calendar-grid calendar-days"></div>
                        </div>`;
                        break;
                     case 'bookmark':
                        toolTitle = '書籤';
                        toolContentHTML = `
                            <div class="bookmark-widget p-2">
                                <div class="bookmark-list"></div>
                                <div class="bookmark-add-form">
                                    <input type="text" name="name" placeholder="名稱" class="w-1/3">
                                    <input type="text" name="url" placeholder="https://..." class="flex-1">
                                    <button class="btn-primary add-bookmark">新增</button>
                                </div>
                            </div>`;
                        break;
                     case 'group':
                        toolTitle = '分組工具';
                        toolContentHTML = `<div class="flex flex-col space-y-2 group-widget">
                                     <div class="flex border-b border-gray-200 -mt-4 -mx-4 px-4">
                                         <button class="tab-button active" data-tab="grouping">分組</button>
                                         <button class="tab-button" data-tab="manage">名單管理</button>
                                     </div>
                                     <div class="tab-content active" data-tab="grouping">
                                         <div class="flex space-x-2 items-center mb-2">
                                             <label class="text-xs text-gray-600 flex-shrink-0">班級:</label>
                                             <select class="class-select flex-1 text-sm">
                                                 <option value="">-- 無班級 --</option>
                                             </select>
                                         </div>
                                         <textarea class="group-names p-2 h-20 text-sm" placeholder="使用班級名單或手動輸入..."></textarea>
                                         <div class="group-options grid grid-cols-2 gap-2 my-2 text-sm">
                                             <label><input type="radio" name="${toolId}-group-type" value="by-count" checked> 分成 <input type="number" class="group-count" value="2" min="2"> 組</label>
                                             <label><input type="radio" name="${toolId}-group-type" value="by-size"> 每組 <input type="number" class="group-size" value="2" min="2"> 人</label>
                                         </div>
                                         <button class="btn-primary do-group w-full">開始分組</button>
                                          <div class="remove-option">
                                             <input type="checkbox" id="${toolId}-remove-picked" class="remove-picked-checkbox">
                                             <label for="${toolId}-remove-picked">從名單中移除已分組者</label>
                                         </div>
                                     </div>
                                     <div class="tab-content" data-tab="manage">
                                         <div class="flex items-center space-x-2 mb-2">
                                             <input type="text" class="class-name flex-1 text-sm" placeholder="新班級名稱...">
                                             <button class="btn-primary add-class text-sm">新增</button>
                                         </div>
                                         <div class="class-list-container"><p class="text-center text-gray-500 text-xs p-2">尚未新增任何班級</p></div>
                                     </div>
                                     <div class="group-result-container mt-2"></div>
                                 </div>`;
                        break;
                }

                // Create the tool widget HTML
                const $tool = $(`
                    <div id="${toolId}" class="tool-widget ${toolClasses}" data-type="${toolType}">
                        <div class="tool-header">
                            <span class="font-medium">${toolTitle}</span>
                            <div>
                                <button class="btn-icon collapse-tool w-7 h-7 rounded-md" title="收合"><i class="fas fa-minus"></i></button>
                                <button class="btn-icon close-tool w-7 h-7 rounded-md" title="關閉"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <div class="tool-content">${toolContentHTML}</div>
                    </div>`);

                // Set initial position and size, applying saved state if it exists
                const initialPos = savedState.position || {
                    left: Math.random() * (whiteboard.width() - toolWidth - 20) + 10,
                    top: Math.random() * (whiteboard.height() - toolHeight - 20) + 10
                };
                $tool.css({
                    left: initialPos.left, top: initialPos.top,
                    width: savedState.size?.width || toolWidth,
                    height: savedState.size?.height || toolHeight
                });
                if (savedState.zIndex) $tool.css('zIndex', savedState.zIndex);
                if (savedState.collapsed) { $tool.addClass('collapsed'); }


                // Append tool to the whiteboard and make it interactive
                whiteboard.append($tool);
                $tool.draggable({
                    handle: ".tool-header",
                    containment: "parent",
                    stop: saveToolsState
                }).resizable({
                    minHeight: 120, minWidth: 180,
                    handles: 'n, e, s, w, ne, se, sw, nw',
                    stop: function(event, ui) {
                        saveToolsState();
                        // Manually trigger resize for responsive elements if needed
                         window.dispatchEvent(new Event('resize'));
                    }
                }).on('mousedown', () => bringToFront($tool));

                // Add tool-specific logic via event handlers
                $tool.find('.close-tool').on('click', () => { clearToolResources($tool[0]); $tool.remove(); saveToolsState(); });
                $tool.find('.collapse-tool').on('click', () => { $tool.toggleClass('collapsed'); saveToolsState(); });

                // Initialize tool-specific functionality based on type
                switch (toolType) {
                    case 'timer': initializeTimer($tool, savedState); break;
                    case 'picker': initializePicker($tool, savedState); break;
                    case 'sticky': initializeSticky($tool, savedState); break;
                    case 'youtube': initializeYoutube($tool, savedState); break;
                    case 'clock': initializeClock($tool, savedState); break;
                    case 'calendar': initializeCalendar($tool, savedState); break;
                    case 'bookmark': initializeBookmark($tool, savedState); break;
                    case 'group': initializeGroup($tool, savedState); break;
                }
                saveToolsState(); // Save initial state of the new tool
                window.dispatchEvent(new Event('resize')); // Trigger font adjustment for new tool
            }

            // --- Tool Initializers ---
            function initializeTimer($tool, savedState = {}) {
                const minutesDisplay = $tool.find('.timer-minutes');
                const secondsDisplay = $tool.find('.timer-seconds');
                const startBtn = $tool.find('.timer-start');
                const resetBtn = $tool.find('.timer-reset');
                const minutesInput = $tool.find('.timer-minutes-input');
                const secondsInput = $tool.find('.timer-seconds-input');
                let countdownInterval = null;
                let totalSeconds, isRunning = false;

                function updateDisplay() {
                    const mins = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                    const secs = (totalSeconds % 60).toString().padStart(2, '0');
                    minutesDisplay.text(mins);
                    secondsDisplay.text(secs);
                }

                function setTime(mins, secs) {
                    minutesInput.val(mins);
                    secondsInput.val(secs);
                    totalSeconds = parseInt(mins, 10) * 60 + parseInt(secs, 10);
                    updateDisplay();
                }

                function startTimer() {
                    if (isRunning) return;
                    if (totalSeconds <= 0) return;
                    isRunning = true;
                    startBtn.text('暫停');
                    countdownInterval = setInterval(() => {
                        totalSeconds--;
                        updateDisplay();
                        if (totalSeconds <= 0) {
                            stopTimer();
                            timerAudio.play();
                            $tool.find('.timer-display').addClass('times-up');
                        }
                    }, 1000);
                     $tool.data('countdownInterval', countdownInterval);
                }

                function stopTimer() {
                    clearInterval(countdownInterval);
                    isRunning = false;
                    startBtn.text('開始');
                }

                function resetTimer() {
                    stopTimer();
                    setTime(minutesInput.val(), secondsInput.val());
                    $tool.find('.timer-display').removeClass('times-up');
                    timerAudio.pause();
                    timerAudio.currentTime = 0;
                }

                startBtn.on('click', () => { isRunning ? stopTimer() : startTimer(); saveToolsState(); });
                resetBtn.on('click', resetTimer);
                $tool.find('.time-preset').on('click', function() {
                    setTime($(this).data('min'), $(this).data('sec') || 0);
                    resetTimer();
                });
                minutesInput.add(secondsInput).on('change', () => {
                     let mins = parseInt(minutesInput.val()) || 0;
                     let secs = parseInt(secondsInput.val()) || 0;
                     if (secs > 59) { secs = 59; secondsInput.val(59); }
                     if (mins > 99) { mins = 99; minutesInput.val(99); }
                     setTime(mins, secs);
                     resetTimer();
                });

                // Initial setup
                setTime(savedState.minutes || 5, savedState.seconds || 0);
                if (savedState.isRunning) startTimer();
            }
             function initializePicker($tool, savedState = {}) {
                  const namesInput = $tool.find('.picker-names'); const result = $tool.find('.picker-result');
                  const pickBtn = $tool.find('.picker-pick'); const tabButtons = $tool.find('.tab-button');
                  const tabContents = $tool.find('.tab-content'); const classSelect = $tool.find('.class-select');
                  const classNameInput = $tool.find('.class-name'); const addClassBtn = $tool.find('.add-class');
                  const classList = $tool.find('.class-list'); const removePickedCheckbox = $tool.find('.remove-picked-checkbox');
                  const restoreBtn = $tool.find('.restore-list-btn');
                  let savedClasses = {}; let currentOriginalNames = "";
                  let designatedNumberStr = '';
                  let designatedNumberTimeout;
                  let lastClickTime = 0;
                  let clickTimeout = null;
                  let designatedIndexForNextPick = null; // New state variable
  
                  // Listen for number key presses for designated picking
                  $(document).on('keydown.picker.' + $tool.attr('id'), function(e) {
                     if ($(e.target).is('input, textarea')) { return; }
                     if (e.key >= '0' && e.key <= '9') {
                         e.preventDefault();
                         designatedNumberStr += e.key;
                         clearTimeout(designatedNumberTimeout);
                         designatedNumberTimeout = setTimeout(() => { designatedNumberStr = ''; }, 1500);
                     }
                  });
  
                  $tool.on('remove', function() { $(document).off('keydown.picker.' + $tool.attr('id')); });
 
                  try {
                      const savedClassesJson = localStorage.getItem(STORAGE_KEY_PICKER_CLASSES);
                      if (savedClassesJson) {
                          const loadedData = JSON.parse(savedClassesJson); savedClasses = {};
                          for (const className in loadedData) {
                              if (typeof loadedData[className] === 'string') { savedClasses[className] = { current: loadedData[className], original: loadedData[className] }; }
                              else if (loadedData[className] && typeof loadedData[className].current === 'string') { savedClasses[className] = { current: loadedData[className].current, original: loadedData[className].original !== undefined ? loadedData[className].original : loadedData[className].current }; }
                          }
                      }
                  } catch (e) { console.error('Error loading/parsing saved classes:', e); savedClasses = {}; }
 
                  function updatePickerUI(selectDefaultClass = false) { const hasClasses = Object.keys(savedClasses).length > 0; updateClassList(); updateClassSelect(hasClasses, selectDefaultClass); loadSelectedClassNames(); classSelect.find('option[value=""]').toggle(!hasClasses); }
                  tabButtons.on('click', function() { const tabName = $(this).data('tab'); tabButtons.removeClass('active'); $(this).addClass('active'); tabContents.removeClass('active').hide(); tabContents.filter(`[data-tab="${tabName}"]`).addClass('active').show(); if (tabName === 'names') loadSelectedClassNames(); });
                  tabContents.not('.active').hide();
                  addClassBtn.on('click', () => { const className = classNameInput.val().trim(); if (className && !savedClasses[className]) { savedClasses[className] = { current: '', original: '' }; classNameInput.val(''); updatePickerUI(true); saveClasses(); } else if (savedClasses[className]) alert('班級名稱已存在！'); });
                  function loadSelectedClassNames() { const selectedClass = classSelect.val(); if (selectedClass && savedClasses[selectedClass]) { namesInput.val(savedClasses[selectedClass].current); currentOriginalNames = savedClasses[selectedClass].original; restoreBtn.prop('disabled', savedClasses[selectedClass].current === currentOriginalNames); } else { namesInput.val(''); currentOriginalNames = ""; restoreBtn.prop('disabled', true); } }
                  classSelect.on('change', loadSelectedClassNames);
                  function updateClassList() { classList.empty(); const sortedClassNames = Object.keys(savedClasses).sort(); if (sortedClassNames.length === 0) { classList.html('<p class="text-center text-gray-500 text-xs p-2">尚未新增任何班級</p>'); return; } sortedClassNames.forEach(className => { const classItem = $(`<div class="class-item flex justify-between items-center px-2 py-1 rounded-md mb-1 text-sm"><span class="flex-1 mr-2 truncate" title="${className}">${className}</span><div class="flex space-x-1"><button class="btn-icon edit-class w-5 h-5 flex items-center justify-center rounded hover:bg-blue-100" data-class="${className}" title="編輯名單"><i class="fas fa-edit text-xs"></i></button><button class="btn-icon delete-class w-5 h-5 flex items-center justify-center rounded hover:bg-red-100" data-class="${className}" title="刪除班級"><i class="fas fa-trash-alt text-xs"></i></button></div></div>`); classList.append(classItem); }); classList.off('click').on('click', '.edit-class', function() { classSelect.val($(this).data('class')); loadSelectedClassNames(); tabButtons.filter('[data-tab="names"]').trigger('click'); }).on('click', '.delete-class', function() { const classNameToDelete = $(this).data('class'); if (confirm(`確定要永久刪除班級「${classNameToDelete}」及其名單嗎？`)) { delete savedClasses[classNameToDelete]; const currentSelection = classSelect.val(); updatePickerUI(); if (currentSelection === classNameToDelete) { const firstClass = Object.keys(savedClasses).sort()[0]; classSelect.val(firstClass || ""); loadSelectedClassNames(); } saveClasses(); } }); }
                  function updateClassSelect(hasClasses, selectDefaultClass = false) { const currentSelection = classSelect.val(); classSelect.find('option:not([value=""])').remove(); const sortedClassNames = Object.keys(savedClasses).sort(); sortedClassNames.forEach(className => { classSelect.append(`<option value="${className}">${className}</option>`); }); let valueToSelect = ""; if (selectDefaultClass && sortedClassNames.length > 0) { valueToSelect = sortedClassNames[sortedClassNames.length - 1]; } else if (savedClasses[currentSelection] !== undefined) { valueToSelect = currentSelection; } else if (hasClasses && sortedClassNames.length > 0) { valueToSelect = sortedClassNames[0]; } classSelect.val(valueToSelect); classSelect.find('option[value=""]').toggle(!hasClasses); }
                  function saveClasses() { try { localStorage.setItem(STORAGE_KEY_PICKER_CLASSES, JSON.stringify(savedClasses)); } catch (e) { console.error('Error saving classes:', e); alert('無法儲存班級名單，空間可能已滿。'); } }
                  namesInput.on('input', function() { const selectedClass = classSelect.val(); if (selectedClass && savedClasses[selectedClass]) { const newContent = $(this).val(); savedClasses[selectedClass].current = newContent; savedClasses[selectedClass].original = newContent; currentOriginalNames = newContent; restoreBtn.prop('disabled', true); saveClasses(); } });
                  removePickedCheckbox.on('change', saveToolsState);
                  restoreBtn.on('click', () => { const selectedClass = classSelect.val(); if (selectedClass && savedClasses[selectedClass]) { namesInput.val(currentOriginalNames); savedClasses[selectedClass].current = currentOriginalNames; restoreBtn.prop('disabled', true); saveClasses(); } });
                  
                  const performPick = () => { // No longer accepts a parameter
                      clearTimeout(designatedNumberTimeout);
  
                      const selectedClass = classSelect.val();
                      if (!selectedClass && Object.keys(savedClasses).length > 0) {
                          alert("請先選擇一個班級。"); designatedNumberStr = ''; return;
                      }
                      let currentNamesList = (savedClasses[selectedClass]?.current || namesInput.val()).split('\n').map(name => name.trim()).filter(name => name !== '');
                      if (currentNamesList.length === 0) {
                          result.text('名單是空的'); designatedNumberStr = ''; return;
                      }
  
                      result.html('<i class="fas fa-spinner fa-spin text-purple-600"></i>');
                      let spinCount = 0;
                      const spinInterval = setInterval(() => {
                          spinCount++;
                          result.text(currentNamesList[Math.floor(Math.random() * currentNamesList.length)]);
                          if (spinCount > 15 + Math.random() * 10) {
                              clearInterval(spinInterval);
                              let finalIndex;
  
                              if (designatedIndexForNextPick !== null) {
                                  finalIndex = designatedIndexForNextPick;
                                  designatedIndexForNextPick = null; // Reset after use
                              } else if (designatedNumberStr) {
                                  const designatedSeat = parseInt(designatedNumberStr, 10);
                                  finalIndex = designatedSeat - 1;
                                  designatedNumberStr = '';
                              } else {
                                  finalIndex = Math.floor(Math.random() * currentNamesList.length);
                              }
  
                              if (finalIndex < 0 || finalIndex >= currentNamesList.length) {
                                  finalIndex = Math.floor(Math.random() * currentNamesList.length);
                              }
  
                              const pickedName = currentNamesList[finalIndex];
                              result.html(`<span class="animate-pulse">${pickedName}</span>`).addClass('animate-pop');
                              setTimeout(() => { result.removeClass('animate-pop').find('span').removeClass('animate-pulse'); }, 700);
  
                              if (removePickedCheckbox.is(':checked')) {
                                  currentNamesList.splice(finalIndex, 1);
                                  const updatedNamesString = currentNamesList.join('\n');
                                  namesInput.val(updatedNamesString);
                                  if (selectedClass && savedClasses[selectedClass]) {
                                      savedClasses[selectedClass].current = updatedNamesString;
                                      restoreBtn.prop('disabled', savedClasses[selectedClass].current === currentOriginalNames);
                                      saveClasses();
                                  }
                              }
                          }
                      }, 50);
                  };
  
                  pickBtn.on('click', () => {
                      clearTimeout(clickTimeout);
                      const currentTime = new Date().getTime();
                      const isDoubleClick = (currentTime - lastClickTime) < 300;
                      lastClickTime = currentTime;
  
                      if (isDoubleClick) {
                          designatedIndexForNextPick = new Date().getSeconds() - 1; // Set state variable and correct for 1-based thinking
                          pickBtn.css('transition', 'box-shadow 0.1s ease-in-out').css('box-shadow', '0 0 0 3px #c4b5fd');
                          setTimeout(() => pickBtn.css('box-shadow', ''), 200);
                          performPick(); // Call without params
                          lastClickTime = 0;
                      } else {
                          designatedIndexForNextPick = null; // Ensure it's null for single click
                          clickTimeout = setTimeout(() => {
                              performPick(); // Call without params
                          }, 250);
                      }
                  });
                  updatePickerUI(); // Initial load
             }

            // Sticky Note Initializer (Added color bar background setting)
            function initializeSticky($tool, savedState = {}) {
                 const contentArea = $tool.find('.sticky-content');
                 const header = $tool.find('.tool-header');
                 const colorDotsContainer = $tool.find('.sticky-note-colors'); // Get the color dots container
                 const bodyContainer = $tool.find('.sticky-note-body'); // Get the body container

                 function setStickyColor(color) {
                     // Set background for the main widget, body, and color bar
                     $tool.css('background-color', color);
                     bodyContainer.css('background-color', color);
                     colorDotsContainer.css('background-color', color);

                     // Set header color (slightly darker)
                     const headerColor = lightenColor(color, -8);
                     header.css('background-color', headerColor);
                     header.css('border-bottom-color', lightenColor(color, -15));
                     // Ensure text color contrasts well (optional, might need more logic)
                     // header.css('color', isDark(headerColor) ? '#ffffff' : '#374151');
                 }

                 // Set initial state
                 const initialColor = savedState.backgroundColor || '#fef9c3';
                 setStickyColor(initialColor);
                 contentArea.val(savedState.content || '');

                 // Event listeners for color dots
                 $tool.find('.color-dot').on('click', function() {
                     setStickyColor($(this).data('color'));
                     saveToolsState();
                 });
                 contentArea.on('input', saveToolsState);
            }

            // Clock Initializer (Same as v4)
             function initializeClock($tool, savedState = {}) {
                 const timeDisplay = $tool.find('.clock-time'); const dateDisplay = $tool.find('.clock-date'); let clockInterval = null;
                function updateClock() {
                    const now = new Date();
                    timeDisplay.text(now.toLocaleTimeString('en-US', { hour12: false }));
                    dateDisplay.text(now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }));
                }
                updateClock();
                clockInterval = setInterval(updateClock, 1000);
                 $tool.data('clockIntervalId', clockInterval); // Store for cleanup
            }

            // Calendar Initializer (Same as v4)
            function initializeCalendar($tool, savedState = {}) {
                const monthYearDisplay = $tool.find('.calendar-month-year');
                const daysContainer = $tool.find('.calendar-days');
                let currentDate = new Date();

                function renderCalendar() {
                    daysContainer.empty();
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    monthYearDisplay.text(`${year}年 ${month + 1}月`);

                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const today = new Date();

                    for (let i = 0; i < firstDay; i++) { daysContainer.append('<div></div>'); }
                    for (let i = 1; i <= daysInMonth; i++) {
                        const dayEl = $(`<div class="calendar-day">${i}</div>`);
                        if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
                            dayEl.addClass('today');
                        }
                        daysContainer.append(dayEl);
                    }
                }

                $tool.find('.prev-month').on('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
                $tool.find('.next-month').on('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });

                renderCalendar();
            }

             // YouTube Initializer
             function initializeYoutube($tool, savedState = {}) {
                 const urlInput = $tool.find('.youtube-url-input');
                 const loadBtn = $tool.find('.youtube-load');
                 const container = $tool.find('.youtube-container');

                 function loadVideo(videoId) {
                     if (!videoId) {
                        container.html('<div class="youtube-placeholder"><i class="fab fa-youtube text-4xl"></i></div>');
                        return;
                     }
                      const iframeHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                     container.html(iframeHTML);
                 }

                 function extractVideoID(url) {
                    if (!url) return null;
                    let videoId = url.split('v=')[1];
                    if (videoId) {
                        const ampersandPosition = videoId.indexOf('&');
                        if (ampersandPosition !== -1) {
                            videoId = videoId.substring(0, ampersandPosition);
                        }
                        return videoId;
                    }
                     // Handle youtu.be short URLs
                     if (url.includes('youtu.be/')) {
                         videoId = url.split('youtu.be/')[1];
                         return videoId;
                     }
                    // If it's just the ID
                    if (url.length === 11 && !url.includes('/')) {
                        return url;
                    }
                    return null;
                }

                 loadBtn.on('click', () => {
                     const videoId = extractVideoID(urlInput.val());
                     loadVideo(videoId);
                     saveToolsState();
                 });

                 urlInput.on('keypress', (e) => {
                     if (e.key === 'Enter') {
                         loadBtn.click();
                     }
                 });

                 if (savedState.videoId) {
                     urlInput.val(`https://www.youtube.com/watch?v=${savedState.videoId}`);
                     loadVideo(savedState.videoId);
                 }
             }

            // --- State Management ---
            function saveToolsState() {
                const toolsState = [];
                $('.tool-widget').each(function() {
                    const $tool = $(this);
                    const toolType = $tool.data('type');
                    const toolData = {
                        type: toolType,
                        id: $tool.attr('id'),
                        position: $tool.position(),
                        size: { width: $tool.width(), height: $tool.height() },
                        zIndex: $tool.css('zIndex'),
                        collapsed: $tool.hasClass('collapsed')
                    };
                    // --- Add Tool Specific Data Saving ---
                         if (toolType === 'sticky') { toolData.content = $tool.find('.sticky-content').val(); toolData.backgroundColor = $tool.css('background-color'); }
                         else if (toolType === 'youtube') { const iframe = $tool.find('iframe'); if (iframe.length) { const url = new URL(iframe.attr('src')); const videoId = url.pathname.split('/').pop(); toolData.videoId = videoId; } }
                         else if (toolType === 'timer') { const timerInstance = $tool.data('timerInstance'); toolData.minutes = $tool.find('.timer-minutes').val(); toolData.seconds = $tool.find('.timer-seconds').val(); toolData.timerRunning = $tool.find('.timer-start').text() === '暫停'; toolData.totalSeconds = timerInstance ? timerInstance.totalSeconds : 0; }
                         else if (toolType === 'picker') { toolData.removePicked = $tool.find('.remove-picked-checkbox').is(':checked'); }
                         // --- End Tool Specific Data Saving ---
                    toolsState.push(toolData);
                });
                try {
                     localStorage.setItem(STORAGE_KEY_TOOLS, JSON.stringify(toolsState));
                } catch (e) {
                     console.error("Error saving tools state:", e);
                }
            }

            function loadToolsState() {
                 // Load drawing
                 const savedDrawing = localStorage.getItem(STORAGE_KEY_DRAWING);
                 if (savedDrawing) { const img = new Image(); img.onload = () => { setTimeout(() => { if(canvas.width > 0 && canvas.height > 0) { ctx.drawImage(img, 0, 0); applyDrawingSettings(); } }, 150); }; img.onerror = () => { console.error('Error loading drawing.'); localStorage.removeItem(STORAGE_KEY_DRAWING); }; img.src = savedDrawing; }
                 else { applyDrawingSettings(); }
                 // Load tools
                const savedTools = localStorage.getItem(STORAGE_KEY_TOOLS);
                if (savedTools) {
                    try {
                         const toolsState = JSON.parse(savedTools);
                         toolsState.sort((a, b) => (parseInt(a.zIndex) || 0) - (parseInt(b.zIndex) || 0)); // Render in correct z-index order
                         toolsState.forEach(toolState => createTool(toolState.type, toolState));
                    } catch (e) {
                         console.error("Error parsing saved tools state:", e);
                         localStorage.removeItem(STORAGE_KEY_TOOLS);
                    }
                }
            }

            // 添加繪圖歷史記錄
            let drawingHistory = [];
            let currentHistoryIndex = -1;
            const maxHistoryLength = 20; // 設置最大歷史記錄長度

            function saveToHistory() {
                // 如果當前不在歷史記錄的末尾，刪除當前位置之後的所有記錄
                if (currentHistoryIndex < drawingHistory.length - 1) {
                    drawingHistory = drawingHistory.slice(0, currentHistoryIndex + 1);
                }

                // 添加新的繪圖狀態到歷史記錄
                drawingHistory.push(canvas.toDataURL());

                // 如果歷史記錄太長，刪除最舊的記錄
                if (drawingHistory.length > maxHistoryLength) {
                    drawingHistory.shift();
                } else {
                    currentHistoryIndex++;
                }

                updateUndoRedoButtons();
            }

            function undoDrawing() {
                if (currentHistoryIndex > 0) {
                    currentHistoryIndex--;
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        updateUndoRedoButtons();
                    };
                    img.src = drawingHistory[currentHistoryIndex];
                }
            }

            function redoDrawing() {
                if (currentHistoryIndex < drawingHistory.length - 1) {
                    currentHistoryIndex++;
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        updateUndoRedoButtons();
                    };
                    img.src = drawingHistory[currentHistoryIndex];
                }
            }

            function updateUndoRedoButtons() {
                $('#undo-drawing').prop('disabled', currentHistoryIndex <= 0);
                $('#redo-drawing').prop('disabled', currentHistoryIndex >= drawingHistory.length - 1);
            }


            // 修改 startDrawing 和 stopDrawing 以集成歷史記錄
            function startDrawing(e) {
                if (e.button !== 0 && e.type === 'mousedown') return;
                drawingState.isDrawing = true;
                const coords = getEventCoords(e);
                [drawingState.lastX, drawingState.lastY] = [coords.x, coords.y];
                ctx.beginPath();
                applyDrawingSettings();
                if (drawingState.isEraser) {
                    ctx.arc(drawingState.lastX, drawingState.lastY, drawingState.lineWidth * 2.5, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.fillStyle = drawingState.color;
                    ctx.arc(drawingState.lastX, drawingState.lastY, drawingState.lineWidth / 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            function stopDrawing() {
                if (drawingState.isDrawing) {
                    drawingState.isDrawing = false;
                    saveToHistory(); // 在停止繪圖時保存到歷史記錄
                    saveDrawing();
                    applyDrawingSettings();
                }
            }
            function clearDrawingCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                localStorage.removeItem(STORAGE_KEY_DRAWING);
                applyDrawingSettings();
                drawingState.isDrawing = false;
                // 清除後保存到歷史記錄
                saveToHistory();
            }


            // 添加事件監聽器
            $('#undo-drawing').on('click', undoDrawing);
            $('#redo-drawing').on('click', redoDrawing);

            // Bookmark Initializer
            function initializeBookmark($tool, savedState = {}) {
                const list = $tool.find('.bookmark-list');
                const addForm = $tool.find('.bookmark-add-form');
                const nameInput = addForm.find('input[name="name"]');
                const urlInput = addForm.find('input[name="url"]');
                const KEY = 'classroom_whiteboard_bookmarks_v1';
                let bookmarks = [];

                function saveBookmarks() {
                    try {
                        localStorage.setItem(KEY, JSON.stringify(bookmarks));
                    } catch (e) {
                        console.error('Error saving bookmarks:', e);
                    }
                }

                function renderBookmarks() {
                    list.empty();
                    if (bookmarks.length === 0) {
                        list.html('<p class="text-center text-xs text-gray-400 p-2">尚無書籤</p>');
                        return;
                    }
                    bookmarks.forEach((bm, index) => {
                        const item = $(`
                            <div class="bookmark-item" data-index="${index}">
                                <a href="${bm.url}" target="_blank" class="bookmark-link" title="${bm.url}">${bm.name}</a>
                                <div class="bookmark-actions">
                                    <button class="btn-icon delete-bookmark" title="刪除"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>`);
                        list.append(item);
                    });
                }

                addForm.on('submit', (e) => {
                    e.preventDefault();
                    const name = nameInput.val().trim();
                    let url = urlInput.val().trim();
                    if (name && url) {
                        if (!url.startsWith('http://') && !url.startsWith('https://')) {
                            url = 'https://' + url;
                        }
                        bookmarks.push({ name, url });
                        saveBookmarks();
                        renderBookmarks();
                        nameInput.val('');
                        urlInput.val('');
                    }
                });
                 addForm.find('.add-bookmark').on('click', () => addForm.submit());


                list.on('click', '.delete-bookmark', function() {
                    const item = $(this).closest('.bookmark-item');
                    const index = parseInt(item.data('index'));
                    if (confirm(`確定要刪除書籤「${bookmarks[index].name}」嗎？`)) {
                        bookmarks.splice(index, 1);
                        saveBookmarks();
                        renderBookmarks();
                    }
                });


                // Load initial bookmarks
                try {
                    bookmarks = JSON.parse(localStorage.getItem(KEY)) || [];
                } catch (e) {
                    bookmarks = [];
                }
                renderBookmarks();
            }

            // Grouping Tool Initializer
            function initializeGroup($tool, savedState = {}) {
                // 共用 picker 的班級名單 localStorage
                const STORAGE_KEY_PICKER_CLASSES = 'classroom_whiteboard_picker_classes_v5';
                const tabButtons = $tool.find('.tab-button');
                const tabContents = $tool.find('.tab-content');
                const classSelect = $tool.find('.class-select');
                const classNameInput = $tool.find('.class-name');
                const addClassBtn = $tool.find('.add-class');
                const classList = $tool.find('.class-list');
                const namesInput = $tool.find('.group-names');
                const removePickedCheckbox = $tool.find('.remove-picked-checkbox');
                const restoreBtn = null; // 分組暫不提供恢復原始名單
                const doGroupBtn = $tool.find('.do-group');
                const resultDiv = $tool.find('.group-result-container');


                let savedClasses = {};
                let currentOriginalNames = "";


                try {
                    const savedClassesJson = localStorage.getItem(STORAGE_KEY_PICKER_CLASSES);
                    if (savedClassesJson) {
                         const loadedData = JSON.parse(savedClassesJson); savedClasses = {};
                         for (const className in loadedData) {
                             if (typeof loadedData[className] === 'string') { savedClasses[className] = { current: loadedData[className], original: loadedData[className] }; }
                             else if (loadedData[className] && typeof loadedData[className].current === 'string') { savedClasses[className] = { current: loadedData[className].current, original: loadedData[className].original !== undefined ? loadedData[className].original : loadedData[className].current }; }
                         }
                    }
                } catch (e) { console.error('Error loading/parsing saved classes:', e); savedClasses = {}; }

                function updateGroupUI(selectDefaultClass = false) {
                    updateClassList();
                    updateClassSelect(Object.keys(savedClasses).length > 0, selectDefaultClass);
                    loadSelectedClassNames();
                }
                tabButtons.on('click', function() {
                     const tabName = $(this).data('tab');
                     tabButtons.removeClass('active');
                     $(this).addClass('active');
                     tabContents.removeClass('active').hide();
                     tabContents.filter(`[data-tab="${tabName}"]`).addClass('active').show();
                     if (tabName === 'grouping') loadSelectedClassNames();
                });
                 tabContents.not('.active').hide();

                addClassBtn.on('click', () => {
                    const className = classNameInput.val().trim();
                    if (className && !savedClasses[className]) {
                        savedClasses[className] = { current: '', original: '' };
                        classNameInput.val('');
                        updateGroupUI(true);
                        saveClasses();
                    } else if (savedClasses[className]) {
                        alert('班級名稱已存在！');
                    }
                });

                function loadSelectedClassNames() {
                    const selectedClass = classSelect.val();
                    if (selectedClass && savedClasses[selectedClass]) {
                        namesInput.val(savedClasses[selectedClass].current);
                        currentOriginalNames = savedClasses[selectedClass].original;
                    } else {
                        namesInput.val('');
                        currentOriginalNames = "";
                    }
                }
                classSelect.on('change', loadSelectedClassNames);
                function updateClassList() { /* Updates the list in the management tab */ classList.empty(); const sortedClassNames = Object.keys(savedClasses).sort(); if (sortedClassNames.length === 0) { classList.html('<p class="text-center text-gray-500 text-xs p-2">尚未新增任何班級</p>'); return; } sortedClassNames.forEach(className => { const classItem = $(`<div class="class-item flex justify-between items-center px-2 py-1 rounded-md mb-1 text-sm"><span class="flex-1 mr-2 truncate" title="${className}">${className}</span><div class="flex space-x-1"><button class="btn-icon edit-class w-5 h-5 flex items-center justify-center rounded hover:bg-blue-100" data-class="${className}" title="編輯名單"><i class="fas fa-edit text-xs"></i></button><button class="btn-icon delete-class w-5 h-5 flex items-center justify-center rounded hover:bg-red-100" data-class="${className}" title="刪除班級"><i class="fas fa-trash-alt text-xs"></i></button></div></div>`); classList.append(classItem); }); classList.off('click').on('click', '.edit-class', function() { classSelect.val($(this).data('class')); loadSelectedClassNames(); tabButtons.filter('[data-tab="grouping"]').trigger('click'); }).on('click', '.delete-class', function() { const classNameToDelete = $(this).data('class'); if (confirm(`確定要永久刪除班級「${classNameToDelete}」及其名單嗎？`)) { delete savedClasses[classNameToDelete]; const currentSelection = classSelect.val(); updateGroupUI(); if (currentSelection === classNameToDelete) { const firstClass = Object.keys(savedClasses).sort()[0]; classSelect.val(firstClass || ""); loadSelectedClassNames(); } saveClasses(); } }); }
                function updateClassSelect(hasClasses, selectDefaultClass = false) {
                    const currentSelection = classSelect.val();
                    classSelect.find('option:not([value=""])').remove();
                    const sortedClassNames = Object.keys(savedClasses).sort();
                    sortedClassNames.forEach(className => {
                        classSelect.append(`<option value="${className}">${className}</option>`);
                    });
                    let valueToSelect = "";
                    if (selectDefaultClass && sortedClassNames.length > 0) {
                        valueToSelect = sortedClassNames[sortedClassNames.length - 1];
                    } else if (savedClasses[currentSelection] !== undefined) {
                        valueToSelect = currentSelection;
                    } else if (hasClasses && sortedClassNames.length > 0) {
                        valueToSelect = sortedClassNames[0];
                    }
                    classSelect.val(valueToSelect);
                }
                function saveClasses() { try { localStorage.setItem(STORAGE_KEY_PICKER_CLASSES, JSON.stringify(savedClasses)); } catch (e) { console.error('Error saving classes:', e); alert('無法儲存班級名單，空間可能已滿。'); } }
                namesInput.on('input', function() {
                    const selectedClass = classSelect.val();
                    if (selectedClass && savedClasses[selectedClass]) {
                        const newContent = $(this).val();
                        savedClasses[selectedClass].current = newContent;
                        savedClasses[selectedClass].original = newContent;
                        currentOriginalNames = newContent;
                        saveClasses();
                    }
                });
                removePickedCheckbox.on('change', saveToolsState);
                doGroupBtn.on('click', doGroup);

                function doGroup() {
                    const selectedClass = classSelect.val();
                    let names = (selectedClass && savedClasses[selectedClass]) ? savedClasses[selectedClass].current.split('\n').map(x => x.trim()).filter(x => x) : namesInput.val().split('\n').map(x => x.trim()).filter(x => x);
                    if (names.length < 2) { resultDiv.html('<span class="text-gray-400">名單太少，無法分組</span>'); return; }
                    
                    // Shuffle names
                    for (let i = names.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [names[i], names[j]] = [names[j], names[i]];
                    }

                    const groupType = $(`input[name="${toolId}-group-type"]:checked`).val();
                    let groups = [];

                    if (groupType === 'by-count') {
                        const count = parseInt($tool.find('.group-count').val()) || 2;
                        for (let i = 0; i < count; i++) groups.push([]);
                        names.forEach((name, i) => groups[i % count].push(name));
                    } else { // by-size
                        const size = parseInt($tool.find('.group-size').val()) || 2;
                        for (let i = 0; i < names.length; i += size) {
                            groups.push(names.slice(i, i + size));
                        }
                    }

                    // Display results
                    let html = '<div class="grid grid-cols-2 gap-2 text-sm">';
                    groups.forEach((group, i) => {
                        html += `<div class="p-2 border rounded-md bg-gray-50"><div class="font-bold mb-1 text-purple-600">第 ${i + 1} 組</div><div>${group.join('<br>')}</div></div>`;
                    });
                    html += '</div>';
                    resultDiv.html(html);

                    if (removePickedCheckbox.is(':checked')) {
                        const selectedClass = classSelect.val();
                        if (selectedClass && savedClasses[selectedClass]) {
                            let remain = names.slice(groups.flat().length);
                            savedClasses[selectedClass].current = remain.join('\n');
                            namesInput.val(savedClasses[selectedClass].current);
                            saveClasses();
                        }
                    }
                }
                updateGroupUI();
            }


            // --- Initial Load ---
            resizeCanvas();
            loadToolsState();
            saveToHistory();
            updateUndoRedoButtons();
            window.addEventListener('resize', adjustFontSize);
            adjustFontSize();
        });
    </script>
</body>
</html>
